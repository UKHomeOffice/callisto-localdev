version: "3.9"

x-db-env-conf: &db-env
  DATABASE_NAME: ${DATABASE_NAME}
  DATABASE_USERNAME: ${PSQL_USER}
  DATABASE_PASSWORD: ${PSQL_PASSWORD}
  DATABASE_ENDPOINT: postgres
  DATABASE_PORT: 5432

# not sure if we need to keep that one as it's doing just verry little for us :/ :/
x-db-settings: &db-settings
  environment:
    <<: *db-env
  networks:
    - callisto

x-liquibase-settings: &liquibase-setting
  pull_policy: ${PULL_POLICY}
  volumes:
    - ./liquibase/liquibase-setup.sh:/liquibase-setup.sh
  command: chmod +x /liquibase-setup.sh
  entrypoint: /liquibase-setup.sh
  networks:
    - callisto
  depends_on:
    postgres:
      condition: service_healthy

services:
  postgres:
    image: postgres:13.1
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=${PSQL_PASSWORD}
      - POSTGRES_USER=${PSQL_USER}
      - POSTGRES_DB=${DATABASE_NAME}
    networks:
      - callisto
    healthcheck:
      test: ["CMD", "psql", "-U", "${PSQL_USER}", "-d", "${DATABASE_NAME}"]
      interval: 500ms
      timeout: 1s
      retries: 5
    volumes:
      - ./sql:/docker-entrypoint-initdb.d # This volume store sql files that are executed automaticallyby Postgres.

  ingress:
    image: nginx:1.19.2-alpine
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./ingress/default.conf:/etc/nginx/conf.d/default.conf
      - ./ingress/nginx-selfsigned.crt:/etc/ssl/certs/hostname-cert.crt:ro
      - ./ingress/nginx-selfsigned.key:/etc/ssl/private/hostname.key:ro
    networks:
      - callisto

  keycloak:
    image: "340268328991.dkr.ecr.eu-west-2.amazonaws.com/callisto/auth-keycloak:$KEYCLOAK_TAG"
    pull_policy: ${PULL_POLICY}
    environment:
      - DB_VENDOR=h2
      - PROXY_ADDRESS_FORWARDING=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/auth"]
      start_period: 30s
    command:
      - "-Djboss.http.port=9090"
    ports:
      - "50000:9090"
    networks:
      - callisto

  web:
    image: "340268328991.dkr.ecr.eu-west-2.amazonaws.com/callisto/ui:$WEB_TAG"
    pull_policy: ${PULL_POLICY}
    ports:
      - "50001:9090"
    networks:
      - callisto

  timecard-database-migrations:
    <<: *liquibase-setting
    image: "340268328991.dkr.ecr.eu-west-2.amazonaws.com/callisto/timecard-database:$TIMECARD_RESTAPI_TAG"
    environment:
      databaseSchemaName: timecard
      <<: *db-env

  timecard-restapi:
    <<: *db-settings
    image: "340268328991.dkr.ecr.eu-west-2.amazonaws.com/callisto/timecard-restapi:$TIMECARD_RESTAPI_TAG"
    ports:
      - "50100:9090"
    depends_on:
      - timecard-database-migrations

  accruals-restapi:
    <<: *db-settings
    image: "340268328991.dkr.ecr.eu-west-2.amazonaws.com/callisto/accruals-restapi:$ACCRUALS_RESTAPI_TAG"
    command:
      - "--server.port=9090" # Having to override server port as application.properties is setting it to a different port
    ports:
      - "50200:9090"

networks:
  callisto:
    driver: bridge
